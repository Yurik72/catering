@model UserSubGroupViewModel
@inject CateringPro.Core.SharedViewLocalizer Localizer

@{

    var ModelName = Localizer["UserSubGroups"];
    ViewData["Title"] = ModelName;

}


<div class="container-xl container container-md container-sm container-lg">
    <div class="row align-items-center pb-3  ml-xl-0 ml-md-0 ml-sm-0 p-0 ml-0" style="margin-top: 48px">
        <div class="col-7 col-xl-9 col-md-6 col-sm-6 align-content-center mr-md-auto pl-0">
            <p class="h2" style="font-weight: 600">
                @ModelName
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div id="grouptree">
                <ul>
                    @foreach (var it in Model.Root.AsList())
                    {

                        @await Html.PartialAsync("Node", it)
                    }
                </ul>
            </div>

        </div>

    </div>
</div>



@section Styles
{
    <link rel="stylesheet" href="~/css/stylejstree.css" />
}

@section scripts
{
    <script src="~/js/jstree.min.js"></script>
    <script>
        $(function () {
            // 6 create an instance when the DOM is ready

            var dlg_addgroup = $('#modDialog-addgroup');
            $('#grouptree').jstree({
                "core": {
                    "animation": 0,
                    "check_callback": true,
                    "themes": { "stripes": true }

                },
                "types": {
                    "#": {
                        "max_children": 1,
                        "max_depth": 4,
                        "valid_children": ["root"]
                    },
                    "root": {
                        "icon": "/static/3.3.10/assets/images/tree_icon.png",
                        "valid_children": ["default"]
                    },
                    "default": {
                        "valid_children": ["default", "file"]
                    },
                    "file": {
                        "icon": "glyphicon glyphicon-file",
                        "valid_children": []
                    }
                },

                "plugins": [
                    "contextmenu", "dnd", "search",
                    "state", "types", "wholerow"
                ]
            })
                .bind("move_node.jstree", function (e, data) {
                    changegroup('move', data);
                })
                .bind("rename_node.jstree", function (e, data) {
                    changegroup('rename', data);
                })
                .bind("create_node.jstree", function (e, data) {
                    changegroup('create', data);
                })
                .bind("delete_node.jstree", function (e, data) {
                    changegroup('delete', data);
                });
            function changegroup(mode, data) {
                const formData = new FormData();
                formData.append('name', data.node.text);
                formData.append('parentid', data.node.parent);
                formData.append('id', data.node.id);
                var action = "Change";
                switch (mode) {
                    case 'create':
                        action = 'Create';
                       
                        break;
                    case 'delete':
                        action = 'Delete';
                        break;
                    default:
                        break;

                }
                //formData.append('TransactionDate', (new Date).toJSON().slice(0, 10).split("-").reverse().join("."));
                const url = `/UserSubGroups/${action}`;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json, application/xml, text/plain, text/html, *.*',

                    },
                    body: formData
                })
                    .then(response => {
                        if (response.ok != true) {
                            throw response.statusText;
                        }
                        return response.json();
                        //loadfin();
                    })
                    .then(json => {
                        if (mode == 'create') {
                            $('#grouptree').jstree(true).set_id(data.node, json.id);
                        }
                     }
                     )
                        .catch(error =>
                            dialog_error(error)
                        );

                


            }

        });
    </script>
}