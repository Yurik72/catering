@{
    ViewData["Title"] = "Окно выдачи заказов";
    Layout = null;
    int numDishes = 5;
}


<!doctype html>
<html lang="en">

<head>
    <link rel="stylesheet" href="~/css/service.css">
    <link rel="stylesheet" href="~/css/bootstrap.min.css" />
</head>
<body>
    <header class="main-header">

        <h1>Окно выдачи заказов</h1>
        <h1 id="currentdate"></h1>
    </header>

    <div class="container order-service">
        <div id="nfc_isoffline" class="row container-state bg-danger text-white" style="display: none;">
            <div class="col-4 container-state">
                <span id="nfc_isoffline">
                    NFC Reader Offline
                </span>
                <span id="error-offline" class="service-status error"></span>
            </div>
            <div class="col-4 container-state">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" ">URL</span>
                    </div>
                    <input id="nfcurl" class="form-control" value="wss://localhost:44360/ws" />
                </div>


            </div>
            <div class="col-4 container-state">
                <button id="connectnfc" class="btn btn-info">Connect NFC</button>
            </div>
        </div>
        <div id="nfc_isonline" class="row bg-success text-white" style="display: none;">
            <div class="col-4 container-state">
                <img id="nfc_image" src="~/images/acr122u.png" style="width:50px;height:50px;" />

            </div>
            <div class="col-4 container-state">
                <span class="service-status online">
                    <span id="nfc_readername"></span>
                    NFC Reader Online
                </span>

                <span id="error-online" class="service-status error"></span>
            </div>
            <div class="col-4 container-state">
                <span>Scan card at any time to detect user</span>

            </div>
        </div>
        <div class="row dishes-num">
            <div data-num="-1" class="col-2 order-dish-select welcome border rounded bg-secondary text-white btn">
                @* <span data-num="-1" class="order-dish-select welcome w-100">Welcome</span>*@
                Welcome

            </div>
            @for (int i = 1; i <= numDishes; i++)
            {
                <div data-num="@i" class="col-2 order-dish-select border rounded bg-secondary text-white btn">
                    @i Блюдо
                </div>
            }
        </div>
        <div class="row delivery-command text-center">
            <div class="col-6">
                <button id="btnstart" class="service-action btn btn-primary">Почати</button>
            </div>
            <div class="col-6">
                <button id="btnstop" class="service-action btn btn-danger">Припинити</button>
            </div>

        </div>
        <div id="userinfo" class="row" style="display: none;">
            <div class="col-4">
                <label for="userid">userid</label>
                <input id="userid" />
            </div>
            <div class="col-4">
                <button id="btnsend" class="service-action btn btn-primary">Send</button>
            </div>
        </div>
        <div id="delivery-dishes-row" class="row" style="display: none;">
            <div id="delivery-dishes-content" class="col-12 delivery-dishes-content">

            </div>
        </div>
        <div id="delivery-queue-row" class="row" style="display: none;">
            <div class="col-12">
                <div id="delivery-queue-content" class="container  delivery-queue-content">

                </div>
            </div>
        </div>
        <div id="delivery-welcome-row" class="row" style="display: none;">
            <div class="col-12">
                <div id="delivery-welcome-content" class="container  delivery-welcome-content">

                </div>
            </div>
        </div>
    </div>

    <script src="./js/jquery.min.js"></script>
    <script src="~/js/bootstrap.min.js"></script>
    <script src="../js/resources.js"></script>
    <script src="../js/site.js"></script>
    <script src="./js/nfcsocket.js"></script>

    @*
        <script src="./js/service.js"></script>
    *@
    <script>
        $(function () {
//setting
            var isQueueMode = true;
            const max_queue = 5;

//session state
            var isStarted = false;
            var isNfcConnected = false;
            var lastQueueid = -1;



            var el_online = $("#isonline");
            var el_offline = $("#isoffline");
            var elnfc_online = $("#nfc_isonline");
            var elnfc_offline = $("#nfc_isoffline");
            var el_error = $("#error");
            el_online.hide();
            const key_url = 'nfcurl';
            el_offline.hide();
            elnfc_online.hide();
            elnfc_offline.show();
            $('#nfcurl').val(localStorage[key_url] || 'wss://localhost:44360/ws');
            var curr_date = new Date();
            var readable_date = curr_date.toJSON().slice(0, 10).split("-").reverse().join(".");
            //$('#currentdate').text(curr_date.getDate() + "." + (curr_date.getMonth() + 1) + "." + curr_date.getFullYear());
            $('#currentdate').text(readable_date);
            localStorage[key_url] = $('#nfcurl').val();
            var nfcsock = new nfc_socket($('#nfcurl').val(),
                function (data) {
                    console.log(data);
                },
                function (cmd, event) {
                    console.log(cmd);
                    console.log(event);
                    if (cmd === 'open') {
                        nfcsock.getstatus(function () { });
                    }
                }
            );
            //todo
            $('#connectnfc').click(function (e) {
                e.preventDefault();
                $('#connectnfc').prop('disabled', true);
                nfcsock.connect();

            });
            nfcsock.on('status', function (msg) {
                showNfcInfo(msg);
            });
            nfcsock.on('error', function (msg) {
                $('#connectnfc').prop('disabled', false);
                dialog_error(msg);
            });
            nfcsock.on('cardreaded', function (msg) {
                $('#userid').val(msg.Cardtag);
                if (IsWelcomeMode() && isQueueMode && isStarted) {
                    requestfordelivery(filldeliverydishes);
                }
               // else if (isQueueMode) {
               //     requestfordeliveryQueue(fillQueue);
              //  }
              //  else {
              //      requestfordelivery(filldeliverydishes);
              //  }

            });


           
        /*  TO DOfor service worker
            $.post(actionUrl, ServiceRequest).done(function (data, statusText, xhr) {
                el_offline.hide();
                el_online.show();
            })
                .fail(function (xhr, code, error) {
                    el_offline.show();
                    el_online.hide();
                });
            */
            function IsWelcomeMode() {
                return $(".order-dish-select.welcome").hasClass('active');
            }
            $(".order-dish-select").click(function (e) {
                e.preventDefault();
                if (isStarted)
                    return;
                var dishnum = parseInt($(this).attr('data-num'));
                if (dishnum > 0 && IsWelcomeMode())
                    return;

                if ($(this).hasClass('active')) {
                    $(this).removeClass('active');
                }
                else {
                   
                    if (dishnum < 0)
                        $('.order-dish-select').removeClass('active');
                    $(this).addClass('active')
                }
                $('.order-dish-select').not('active').removeClass("bg-success").addClass('bg-secondary');
                $('.order-dish-select.active').removeClass('bg-secondary').addClass("bg-success");
                refreshNfcState();
                
            });
            refreshState();
            function getdishesnum() {
                return $('.dishes-num').find('.order-dish-select.active').map(function (index, element) {
                    return parseInt($(element).attr('data-num'));
                }).get();
            }
            function refreshDeliveryContentState() {
                $('#delivery-dishes-row').hide();
                $('#delivery-queue-row').hide();
                $('#delivery-welcome-row').hide();
                if (IsWelcomeMode()) {
                    $('#delivery-welcome-row').show();
                }
                else if (isQueueMode) {
                    $('#delivery-queue-row').show();
                } else {
                    $('#delivery-dishes-row').show();

                }
            }
            function refreshState() {
                $("#btnstart").prop('disabled', isStarted);
                $("#btnstop").prop('disabled', !isStarted);
                $("#btnsend").prop('disabled', !isStarted);
                if (isStarted) {


                }
                else {

                }
                refreshNfcState();
            }
            function refreshNfcState(){
                if (!IsWelcomeMode()) {
                    elnfc_online.hide();
                    elnfc_offline.hide();
                }
                else if (isNfcConnected) {
                    elnfc_online.show();
                    elnfc_offline.hide();
                }
                else {
                    elnfc_online.hide();
                    elnfc_offline.show();
                }
            }
            function getnewQueue() {

                requestfordeliveryQueue(fillQueue);
                if (isStarted) {
                    setTimeout(getnewQueue, 1000);
                }
            }
            $('#btnstart').click(function (e) {
                e.preventDefault();
                isStarted = true;
                refreshState();
                refreshDeliveryContentState();
                if (isQueueMode) {

                    getnewQueue();
                }
            });
            $('#btnstop').click(function (e) {
                e.preventDefault();
                isStarted = false;
                refreshState();
            });
            $('#btnsend').click(function (e) {
                e.preventDefault();
                requestfordelivery(filldeliverydishes);

            });
            function getQueueCount() {
                return $('#delivery-queue-content').find("user-queue").length;
            }
            function fillWelcome(data) {
                $('#delivery-welcome-content').empty();
                if (!data || data.overalResult != "success") {
                    if (data && data.userFound) {
                        var pictURL = '/Pictures/GetPicture?id=' + data.userPictureId;
                        var divuser = `<div class="row user-welcome bg-danger text-white h1" >
                                        <div class="col-6 welcome-user">
                                            <img src="${pictURL}"/>
                                        </div>
                                      <div class="col-6 welcome-user ">
                                            ${data.userName}
                                        </div>
                                        </div>`
                        $('#delivery-welcome-content').append(divuser);
                    }
                    var div = `<div class="row bg-danger text-white h1"><div class="col-12 container-errordelivery">Помилка:${data.errorMessage}</div></div>`;
                    $('#delivery-welcome-content').append(div);
                    return;
                }
                //var inner_div = data.dishes.map(function (element, index) {
                var inner_div = "";
                data.dishes.forEach(element => {
                    inner_div += `<div class="row"><div class="col-12 welcome-dish bg-primary text-white h2" data-id="${element.id}" data-id=${element.id}>${element.name}</div></div>`;
                });

                var pictureURL =  '/Pictures/GetPicture?id=' + data.userPictureId;
                var div = $(`<div class="row user-welcome bg-info text-white py-2" >
                                        <div class="col-6 welcome-user h1 bg-info text-white">
                                            <span class="welcome-username" >${data.userName}</span>
                                            <img src="${pictureURL}"/>
                                        </div>
                                        <div class="col-6 welcome-dishes">
                                            ${inner_div}
                                         </div>
                                    </div>`);
                $('#delivery-welcome-content').append(div);
            }
            function fillQueue(data) {
                var queunum = getQueueCount() + 1;
                // $('#delivery-queue-content').empty(); // to do
                if (!data || data.overalResult != "success") {

                }
                data.queues.forEach(el => {
                    var inner_div = el.dishes.map(function (element, index) {
                        return `<span class="queue-dish" data-queueid="${el.queueId}" data-id=${element.id}>${element.name}</span> `;
                    });
                    var div = $(`<div class="row user-queue" data-number="${queunum}">
                                            <div class="col-4 queue-user">
                                                <span class="queue-username" >${el.userName}</span>
                                            </div>
                                            <div class="col-4 queue-dishes">
                                                ${inner_div}
                                             </div>
                                        </div>`);
                    $('#delivery-queue-content').append(div);
                    $('#delivery-queue-content').find(".user-queue").removeClass("queue-first");
                    $('#delivery-queue-content').find(".user-queue").first().addClass("queue-first");
                });
            }
            function filldeliverydishes(data) {
                if (IsWelcomeMode()) {
                    fillWelcome(data);
                    return;
                }

                $('#delivery-dishes-content').empty();
                if (!data || data.overalResult != "success") {

                    var div = `<div class="row"><div class="col-8 container-errordelivery"><span class="errordelivery">Помилка:${data.errorMessage}</span></div></div>`;
                    $('#delivery-dishes-content').append(div);
                }
                else if (!Array.isArray(data.dishes) || data.dishes.length == 0) {
                    var div = `<div class="row"><div class="col-8 container-wrongdelivery"><span class="wrongdelivery">Кошик пустий</span></div></div>`;
                    $('#delivery-dishes-content').append(div);
                }
                else {
                    var dishesid = data.dishes.map(function (index, element) { return element.id; });
                    data.dishes.forEach(el => {
                        var div = $(`<div class="row"><div class="col-8 container-deliverydish"><span class="deliverydish" data-id="${el.id}">${el.name}</span></div></div>`);
                        $('#delivery-dishes-content').append(div);
                    });
                    var divconfirm = $(`<div class="row"><div class="col-8 class="button-deliverydish"><button id="delivery-confirm">Пiдвердити</button></div></div>`);
                    $('#delivery-dishes-content').append(divconfirm);
                    divconfirm.find("#delivery-confirm").click(function (e) {
                        e.preventDefault();
                        requestforconfirmation(confirmdeliverydishes, dishesid);

                    });
                }
            }
            function confirmdeliverydishes(data) {

                if (!data || data.overalresult != "success") {
                    var div = `<div class="row"><div class="col-8 container-errordelivery"><span class="errordelivery">Помилка${data.errormessage}</span></div></div>`;
                    $('#delivery-dishes-content').append(div);
                } else {
                    $('#delivery-dishes-content').empty();
                }
            }
            function requestforconfirmation(cb, dishesids) {
                var actionUrl = "/Service/RequestForDelivery";
                var dishesnum = getdishesnum();
                var ServiceRequest = { DayDate: curr_date.toDateString(), UserToken: $('#userid').val(), UserId: $('#userid').val(), Type: "confirmdelivery", DishesIds: dishesids };
                $.post(actionUrl, ServiceRequest).done(function (data, statusText, xhr) {
                    cb(data);
                })
                    .fail(function (xhr, code, error) {
                        el_error.val(error);
                        el_error.show();
                    });
            }
            function requestfordeliveryQueue(cb) {
                var actionUrl = "/Service/RequestForDelivery";
                var dishesnum = getdishesnum();
                var requesttype = 'askforqueue';

                var ServiceRequest = { DayDate: curr_date.toDateString(), Type: requesttype, DishesNum: dishesnum, MaxQueue=max_queue, LastQueueId=lastQueueid };
                $.post(actionUrl, ServiceRequest).done(function (data, statusText, xhr) {
                    cb(data);
                })
                    .fail(function (xhr, code, error) {
                        el_error.val(error);
                        el_error.show();
                    });
            }
            function requestfordelivery(cb) {
                var actionUrl = "/Service/RequestForDelivery";
                var dishesnum = getdishesnum();
                var requesttype = 'askfordelivery';
                if (IsWelcomeMode())
                    requesttype = 'askforregister';
                var ServiceRequest = { DayDate: curr_date.toDateString(), UserToken: $('#userid').val(), UserId: $('#userid').val(), Type: requesttype, DishesNum: dishesnum };
                $.post(actionUrl, ServiceRequest).done(function (data, statusText, xhr) {
                    cb(data);
                })
                    .fail(function (xhr, code, error) {
                        el_error.val(error);
                        el_error.show();
                    });
            }
            function showNfcInfo(msg) {
                $('#connectnfc').prop('disabled', false);
                if (msg && msg.Isreaderconnected && msg.Ismonitoring) {
                    elnfc_online.show();
                    elnfc_offline.hide();

                    $('#nfc_readername').text(msg.Readername);
                    isNfcConnected = true;
                }
                else {
                    elnfc_online.hide();
                    elnfc_offline.show();
                    isNfcConnected = true;
                }
                refreshState();
            }



        });
    </script>
</body>
</html>